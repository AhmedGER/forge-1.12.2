name: forge-server-with-via
on:
  workflow_dispatch:

jobs:
  minecraft:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 8
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: Download Forge 1.12.2 and Setup
        run: |
          echo "=== Downloading Forge 1.12.2 (Latest) ==="
          # Forge 1.12.2 - 14.23.5.2860 (Latest stable)
          curl -L -o forge-installer.jar \
            "https://maven.minecraftforge.net/net/minecraftforge/forge/1.12.2-14.23.5.2860/forge-1.12.2-14.23.5.2860-installer.jar"
          
          echo "=== Installing Forge Server ==="
          java -jar forge-installer.jar --installServer
          rm forge-installer.jar
          
          # Find the forge jar (name varies)
          FORGE_JAR=$(ls forge-*.jar 2>/dev/null | grep -v installer | head -n 1)
          if [ -z "$FORGE_JAR" ]; then
            FORGE_JAR=$(ls minecraft_server.*.jar 2>/dev/null | head -n 1)
          fi
          
          if [ -n "$FORGE_JAR" ]; then
            mv "$FORGE_JAR" server.jar
            echo "‚úì Forge server ready: $FORGE_JAR -> server.jar"
          else
            echo "‚ö†Ô∏è Could not find Forge jar, listing files:"
            ls -la
            exit 1
          fi
          
          # Create eula.txt
          echo "eula=true" > eula.txt
          echo "‚úì EULA accepted"
          
          # Extract world if exists
          if [ -f world.zip ]; then
            echo "=== Extracting world.zip ==="
            unzip -q world.zip
            echo "‚úì World extracted successfully"
          else
            echo "‚ÑπÔ∏è No world.zip found, will generate new world"
          fi
          
          # Create mods folder
          mkdir -p mods
          echo "‚ÑπÔ∏è Mods folder created"

      - name: Download SpongeForge and ViaVersion Plugins
        run: |
          echo "=== Downloading SpongeForge for 1.12.2 ==="
          # SpongeForge 1.12.2-2838-7.4.7 (Sponge API 7.4)
          curl -L -o mods/_AAspongeforge-1.12.2-2838-7.4.7.jar \
            "https://repo.spongepowered.org/repository/maven-releases/org/spongepowered/spongeforge/1.12.2-2838-7.4.7/spongeforge-1.12.2-2838-7.4.7.jar"
          echo "‚úì SpongeForge downloaded (prefixed with _AA to load first)"
          
          echo "=== Downloading ViaSponge ==="
          # ViaSponge latest for Sponge 7 (1.12.2)
          curl -L -o mods/ViaSponge-4.10.2.jar \
            "https://github.com/ViaVersion/ViaSponge/releases/download/4.10.2/ViaSponge-4.10.2.jar"
          echo "‚úì ViaSponge downloaded"
          
          echo "=== Downloading ViaVersion ==="
          # ViaVersion core
          curl -L -o mods/ViaVersion-5.1.1.jar \
            "https://github.com/ViaVersion/ViaVersion/releases/download/5.1.1/ViaVersion-5.1.1.jar"
          echo "‚úì ViaVersion downloaded"
          
          echo "=== Downloading ViaBackwards ==="
          # ViaBackwards for backward compatibility
          curl -L -o mods/ViaBackwards-5.1.1.jar \
            "https://github.com/ViaVersion/ViaBackwards/releases/download/5.1.1/ViaBackwards-5.1.1.jar"
          echo "‚úì ViaBackwards downloaded"
          
          echo "=== Downloading ViaRewind ==="
          # ViaRewind for older versions support
          curl -L -o mods/ViaRewind-4.0.2.jar \
            "https://github.com/ViaVersion/ViaRewind/releases/download/4.0.2/ViaRewind-4.0.2.jar"
          echo "‚úì ViaRewind downloaded"
          
          echo ""
          echo "‚úì All ViaVersion components installed!"
          echo "‚ÑπÔ∏è Your server now supports clients from 1.7.x to 1.21+"
          echo ""
          ls -lh mods/

      - name: Download and Setup Playit Tunnel
        run: |
          echo "=== Downloading Playit ==="
          curl -SsL https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64 -o playit-linux-amd64
          chmod +x playit-linux-amd64
          echo "‚úì Playit downloaded successfully"
          
          echo "=== Setting up Playit Tunnel with monitoring ==="
          
          if [ -n "${{ secrets.PLAYIT_SECRET }}" ]; then
            echo "${{ secrets.PLAYIT_SECRET }}" > playit.toml
            echo "‚úì Playit configured from secrets"
          elif [ -f playit.toml ]; then
            echo "‚úì Using existing playit.toml"
          else
            echo "‚ö†Ô∏è No playit config found"
          fi
          
          while true; do
            ./playit-linux-amd64 >/dev/null 2>&1 || sleep 5
          done &
          
          echo "‚úì Playit tunnel started with auto-restart"
          echo "‚ÑπÔ∏è Minecraft port (25565) will be tunneled"
          sleep 10

      - name: Run Forge Minecraft Server with ViaVersion
        run: |
          echo "=== Starting Forge 1.12.2 Server with ViaVersion Support ==="
          echo "‚ÑπÔ∏è Players can join from Minecraft 1.7.x to 1.21+"
          echo ""
          
          # Forge 1.12.2 Ÿäÿ¥ÿ™ÿ∫ŸÑ ÿ£ÿ≠ÿ≥ŸÜ ŸÖÿπ Java 8 Ÿà flags ÿ£ÿ®ÿ≥ÿ∑
          java -Xmx14G -Xms10G \
            -XX:+UseG1GC \
            -XX:+ParallelRefProcEnabled \
            -XX:MaxGCPauseMillis=200 \
            -XX:+UnlockExperimentalVMOptions \
            -XX:+DisableExplicitGC \
            -XX:G1NewSizePercent=30 \
            -XX:G1MaxNewSizePercent=40 \
            -XX:G1HeapRegionSize=8M \
            -XX:G1ReservePercent=20 \
            -XX:InitiatingHeapOccupancyPercent=15 \
            -XX:SurvivorRatio=32 \
            -XX:MaxTenuringThreshold=1 \
            -jar server.jar nogui &
          SERVER_PID=$!
          
          echo "‚úì Forge Server started (PID: $SERVER_PID)"
          echo "‚è∞ Server will run for max 5 hours 45 minutes..."
          
          echo "‚è≥ Waiting 2 minutes for Forge + SpongeForge to fully start..."
          sleep 120
          
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  üéÆ Forge 1.12.2 Server with ViaVersion is ONLINE!   ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "‚úì Base Version: Minecraft 1.12.2 with Forge"
          echo "‚úì Supported Clients: 1.7.x - 1.21+"
          echo "‚úì SpongeForge: Enabled"
          echo "‚úì ViaVersion: Active"
          echo ""
          
          if [ -d "mods" ]; then
            MOD_COUNT=$(ls -1 mods/*.jar 2>/dev/null | wc -l)
            echo "‚ÑπÔ∏è Total mods loaded: $MOD_COUNT"
            echo "   - SpongeForge + ViaVersion plugins: 5"
            echo "   - Your custom mods: $((MOD_COUNT - 5))"
          fi
          
          echo ""
          echo "‚ÑπÔ∏è Players with 1.20.1 can now join your 1.12.2 server!"
          echo "‚ÑπÔ∏è Type 'stop' in-game to shutdown server immediately"
          echo ""
          
          MAX_TIME=20700
          ELAPSED=0
          CHECK_INTERVAL=10
          
          while [ $ELAPSED -lt $MAX_TIME ]; do
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo ""
              echo "=== Server Stopped by User ==="
              echo "‚è±Ô∏è Server ran for approximately $((ELAPSED / 60)) minutes"
              break
            fi
            
            sleep $CHECK_INTERVAL
            ELAPSED=$((ELAPSED + CHECK_INTERVAL))
            
            if [ $((ELAPSED % 1800)) -eq 0 ]; then
              echo "‚è∞ Server running... $((ELAPSED / 60)) minutes elapsed"
            fi
          done
          
          if kill -0 $SERVER_PID 2>/dev/null; then
            echo ""
            echo "=== Time Limit Reached - Stopping Server ==="
            kill -TERM $SERVER_PID 2>/dev/null || true
            sleep 5
            kill -9 $SERVER_PID 2>/dev/null || true
          fi
          
          pkill -f "monitor_playit.sh" 2>/dev/null || true
          pkill -TERM playit-linux-amd64 2>/dev/null || true
          sleep 2
          pkill -9 playit-linux-amd64 2>/dev/null || true
          
          echo "‚úì Server stopped"

      - name: Save world, mods and config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          
          if ! git diff --cached --quiet 2>/dev/null; then
            git commit -m "Auto-save Forge+ViaVersion server: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git pull --rebase --autostash \
              https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}.git
            for attempt in {1..3}; do
              git push https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}.git && break
              echo "Push failed (attempt $attempt), retrying in 10 seconds..."
              sleep 10
            done
            echo "‚úì Changes saved to repository"
          else
            echo "‚ÑπÔ∏è No changes to save"
          fi

      - name: Auto-retrigger workflow
        if: github.run_attempt < 3
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          runs=$(gh run list -w forge-server.yml --json status -q \
               '[.[] | select(.status=="queued" or .status=="in_progress")] | length')
          
          if [ "$runs" -le 1 ]; then
            echo "No other workflows running, retriggering..."
            gh workflow run forge-server.yml
            echo "‚úì Workflow retriggered"
          else
            echo "Other workflows are running, skipping retrigger"
          fi
