name: forge-server
on:
  workflow_dispatch:

jobs:
  minecraft:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 8
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: Download Forge 1.12.2 and Setup
        run: |
          echo "=== Downloading Forge 1.12.2 (Latest) ==="
          # Forge 1.12.2 - 14.23.5.2860 (Latest stable)
          curl -L -o forge-installer.jar \
            "https://maven.minecraftforge.net/net/minecraftforge/forge/1.12.2-14.23.5.2860/forge-1.12.2-14.23.5.2860-installer.jar"
          
          echo "=== Installing Forge Server ==="
          java -jar forge-installer.jar --installServer
          rm forge-installer.jar
          
          # Find the forge jar (name varies)
          FORGE_JAR=$(ls forge-*.jar 2>/dev/null | grep -v installer | head -n 1)
          if [ -z "$FORGE_JAR" ]; then
            FORGE_JAR=$(ls minecraft_server.*.jar 2>/dev/null | head -n 1)
          fi
          
          if [ -n "$FORGE_JAR" ]; then
            mv "$FORGE_JAR" server.jar
            echo "✔ Forge server ready: $FORGE_JAR -> server.jar"
          else
            echo "⚠️ Could not find Forge jar, listing files:"
            ls -la
            exit 1
          fi
          
          # Create eula.txt
          echo "eula=true" > eula.txt
          echo "✔ EULA accepted"
          
          # Extract world if exists
          if [ -f world.zip ]; then
            echo "=== Extracting world.zip ==="
            unzip -q world.zip
            echo "✔ World extracted successfully"
          else
            echo "ℹ️ No world.zip found, will generate new world"
          fi
          
          # Create mods folder
          mkdir -p mods
          echo "ℹ️ Mods folder created (place your mods in repo's mods/ folder)"

      - name: Setup Playit Tunnel with Auto-Restart
        run: |
          echo "=== Setting up Playit Tunnel with monitoring ==="
          
          chmod +x playit-linux-amd64
          
          if [ -n "${{ secrets.PLAYIT_SECRET }}" ]; then
            echo "${{ secrets.PLAYIT_SECRET }}" > playit.toml
            echo "✔ Playit configured from secrets"
          elif [ -f playit.toml ]; then
            echo "✔ Using existing playit.toml"
          else
            echo "⚠️ No playit config found"
          fi
          
          while true; do
            ./playit-linux-amd64 >/dev/null 2>&1 || sleep 5
          done &
          
          echo "✔ Playit tunnel started with auto-restart"
          echo "ℹ️ Minecraft port (25565) will be tunneled"
          sleep 10

      - name: Run Forge Minecraft Server
        run: |
          echo "=== Starting Forge 1.12.2 Server ==="
          
          # Forge 1.12.2 يشتغل أحسن مع Java 8 و flags أبسط
          java -Xmx14G -Xms10G \
            -XX:+UseG1GC \
            -XX:+ParallelRefProcEnabled \
            -XX:MaxGCPauseMillis=200 \
            -XX:+UnlockExperimentalVMOptions \
            -XX:+DisableExplicitGC \
            -XX:G1NewSizePercent=30 \
            -XX:G1MaxNewSizePercent=40 \
            -XX:G1HeapRegionSize=8M \
            -XX:G1ReservePercent=20 \
            -XX:InitiatingHeapOccupancyPercent=15 \
            -XX:SurvivorRatio=32 \
            -XX:MaxTenuringThreshold=1 \
            -jar server.jar nogui &
          SERVER_PID=$!
          
          echo "✔ Forge Server started (PID: $SERVER_PID)"
          echo "⏰ Server will run for max 5 hours 45 minutes..."
          
          echo "⏳ Waiting 2 minutes for Forge to fully start (Forge takes longer)..."
          sleep 120
          
          echo ""
          echo "=== Forge Server is now ONLINE ==="
          echo "ℹ️ Version: Minecraft 1.12.2 with Forge"
          echo "ℹ️ Type 'stop' in-game to shutdown server immediately"
          
          if [ -d "mods" ]; then
            MOD_COUNT=$(ls -1 mods/*.jar 2>/dev/null | wc -l)
            echo "ℹ️ Loaded mods: $MOD_COUNT"
          fi
          
          MAX_TIME=20700
          ELAPSED=0
          CHECK_INTERVAL=10
          
          while [ $ELAPSED -lt $MAX_TIME ]; do
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo ""
              echo "=== Server Stopped by User ==="
              echo "⏱️ Server ran for approximately $((ELAPSED / 60)) minutes"
              break
            fi
            
            sleep $CHECK_INTERVAL
            ELAPSED=$((ELAPSED + CHECK_INTERVAL))
            
            if [ $((ELAPSED % 1800)) -eq 0 ]; then
              echo "⏰ Server running... $((ELAPSED / 60)) minutes elapsed"
            fi
          done
          
          if kill -0 $SERVER_PID 2>/dev/null; then
            echo ""
            echo "=== Time Limit Reached - Stopping Server ==="
            kill -TERM $SERVER_PID 2>/dev/null || true
            sleep 5
            kill -9 $SERVER_PID 2>/dev/null || true
          fi
          
          pkill -f "monitor_playit.sh" 2>/dev/null || true
          pkill -TERM playit-linux-amd64 2>/dev/null || true
          sleep 2
          pkill -9 playit-linux-amd64 2>/dev/null || true
          
          echo "✔ Server stopped"

      - name: Save world, mods and config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          
          if ! git diff --cached --quiet 2>/dev/null; then
            git commit -m "Auto-save Forge server: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git pull --rebase --autostash \
              https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}.git
            for attempt in {1..3}; do
              git push https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}.git && break
              echo "Push failed (attempt $attempt), retrying in 10 seconds..."
              sleep 10
            done
            echo "✔ Changes saved to repository"
          else
            echo "ℹ️ No changes to save"
          fi

      - name: Auto-retrigger workflow
        if: github.run_attempt < 3
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          runs=$(gh run list -w forge-server.yml --json status -q \
               '[.[] | select(.status=="queued" or .status=="in_progress")] | length')
          
          if [ "$runs" -le 1 ]; then
            echo "No other workflows running, retriggering..."
            gh workflow run forge-server.yml
            echo "✔ Workflow retriggered"
          else
            echo "Other workflows are running, skipping retrigger"
          fi
